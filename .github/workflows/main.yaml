name: CI/CD for Dockerized Flask App

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    
    build-and-publish: 
      runs-on: ubuntu-latest
      steps:
        # step 1: Check out the code from the repository
        - name: Checkout code
          uses: actions/checkout@v3
        
        # step 2: Set up Docker Buildx (for multi-platform builds, optional)
        - name: Set up a Docker Buildx
          uses: docker/setup-buildx-action@v2
        
        # step 3: Log in to Docker Hub using credentials in Github
        - name: Login to a Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        
        # step 4: Build and push the Docker image to Docker Hub
        - name: Build and push Docker Image
          id: docker_build
          uses: docker/build-push-action@v4
          with: 
            context: .
            file: ./Dockerfile  # Ensure this is the correct path to your Dockerfile
            push: true
            tags: ${{ secrets.DOCKER_USERNAME }}/flask-app:latest  # Docker Hub repo/tag
        
        # step 5: Log the image digest (for reference)
        - name: Image Digest
          run: |
           echo "Image Digest: ${{ steps.docker_build.outputs.digest }}"
    